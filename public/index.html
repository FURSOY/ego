<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGO Otobüs Takip</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <img src="icon.png" class="logo" alt="Logo">
                <h1>Otobüsler</h1>
            </div>
            <div class="header-right">
                <div class="clock" id="clock">--:--:--</div>
            </div>
        </header>

        <!-- Durak Sütunları -->
        <main class="stops-container" id="stops-container">
        </main>

        <!-- Status Bar -->
        <footer class="status-bar" style="display: none;">
            <div class="status-item" id="connection-status">
                <span class="status-dot" id="ws-dot"></span>
                <span id="ws-status">Bağlanıyor...</span>
            </div>
        </footer>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Durak Düzenle</h2>
                <button class="modal-close" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="bus-list" id="stop-list">
                </div>
                <div class="add-bus-form">
                    <h3>Yeni Durak Ekle</h3>
                    <div class="form-row">
                        <input type="text" id="new-stop" placeholder="Durak No (örn: 50782)">
                        <button class="btn btn-add" onclick="addStop()">+ Ekle</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-save" onclick="saveAndReload()">Kaydet ve Yenile</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Uygulama Bilgileri</h2>
                <button class="modal-close" onclick="closeInfoModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Sürüm</span>
                        <span class="info-value" id="app-version">Yükleniyor...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Uygulama</span>
                        <span class="info-value" id="app-name">EGO Otobüs Takip</span>
                    </div>
                </div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Güncelleme Durumu</span>
                        <span class="info-value" id="update-status">Kontrol ediliyor...</span>
                    </div>
                    <div class="info-row" id="update-version-row" style="display: none;">
                        <span class="info-label">Yeni Sürüm</span>
                        <span class="info-value" id="update-version">-</span>
                    </div>
                    <div class="info-row" id="download-progress-row" style="display: none;">
                        <span class="info-label">İndirme</span>
                        <div class="progress-container">
                            <div class="progress-bar" id="download-progress-bar"></div>
                            <span class="progress-text" id="download-progress-text">0%</span>
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Son Kontrol</span>
                        <span class="info-value" id="last-check">-</span>
                    </div>
                </div>
                <div class="info-actions">
                    <button class="btn btn-primary" onclick="checkForUpdates()">Güncelleme Kontrol Et</button>
                    <button class="btn btn-save" id="install-update-btn" style="display: none;"
                        onclick="installUpdate()">Güncellemeyi Yükle</button>
                </div>
            </div>
            <div class="modal-footer">
                <span class="info-hint">E: Durak Düzenle | F: Tam Ekran</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Ayarlar</h2>
                <button class="modal-close" onclick="closeSettingsModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <h3 class="settings-title">Veri Ayarları</h3>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Kaybolma Eşiği</span>
                            <span class="setting-desc">Otobüs kaç çekişte görünmezse silinsin</span>
                        </div>
                        <input type="number" id="setting-miss-count" class="setting-input" min="1" max="50" value="10">
                    </div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Çekim Arası Bekleme (ms)</span>
                            <span class="setting-desc">Her buton tıklaması arasındaki bekleme</span>
                        </div>
                        <input type="number" id="setting-scrape-delay" class="setting-input" min="100" max="10000"
                            step="100" value="500">
                    </div>
                </div>
                <div class="info-section">
                    <h3 class="settings-title">Görünüm</h3>
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Mouse Gizleme Süresi (sn)</span>
                            <span class="setting-desc">Hareketsizlik sonrası mouse gizlenir</span>
                        </div>
                        <input type="number" id="setting-cursor-timeout" class="setting-input" min="1" max="60"
                            value="5">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-save" onclick="saveSettings()">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        // LocalStorage'dan durakları yükle
        let stops = JSON.parse(localStorage.getItem('stops')) || ['50782', '50781', '50780'];

        const stopsContainer = document.getElementById('stops-container');
        const clockElement = document.getElementById('clock');
        const editModal = document.getElementById('edit-modal');
        const wsStatusDot = document.getElementById('ws-dot');
        const wsStatusText = document.getElementById('ws-status');

        let ws = null;
        let wsReconnectTimer = null;

        // Ayarları yükle
        const defaultSettings = { missCount: 10, scrapeDelay: 500, cursorTimeout: 5 };
        let settings = JSON.parse(localStorage.getItem('settings')) || { ...defaultSettings };

        // Kaybolma koruması: stopId -> { line -> { data, missCount } }
        const busTracking = new Map();
        // Pulse timeout: her durak için timer
        const pulseTimers = new Map();

        // Mouse gizleme
        let mouseTimer;
        function showCursor() {
            document.body.style.cursor = 'default';
            clearTimeout(mouseTimer);
            mouseTimer = setTimeout(() => { document.body.style.cursor = 'none'; }, (settings.cursorTimeout || 5) * 1000);
        }
        document.addEventListener('mousemove', showCursor);
        document.addEventListener('mousedown', showCursor);
        mouseTimer = setTimeout(() => { document.body.style.cursor = 'none'; }, (settings.cursorTimeout || 5) * 1000);

        // Saat
        function updateClock() {
            clockElement.textContent = new Date().toLocaleTimeString('tr-TR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Sütunları oluştur
        function initializeColumns() {
            stopsContainer.innerHTML = '';
            stops.forEach(stopId => {
                const column = document.createElement('div');
                column.className = 'stop-column';
                column.id = `stop-${stopId}`;
                column.innerHTML = `
                    <div class="stop-header">
                        <span class="stop-badge">Durak ${stopId}</span>
                        <span class="stop-status" id="status-${stopId}">
                            <span class="pulse"></span>
                        </span>
                    </div>
                    <div class="bus-rows" id="rows-${stopId}">
                        <div class="bus-row loading-row">
                            <span class="loading-text">Yükleniyor...</span>
                        </div>
                    </div>
                `;
                stopsContainer.appendChild(column);

                // Tracking başlat
                busTracking.set(stopId, new Map());
            });
        }

        // Otobüs satırlarını güncelle (kaybolma koruması ile)
        function updateStopData(stopId, buses) {
            const rowsContainer = document.getElementById(`rows-${stopId}`);
            const statusEl = document.getElementById(`status-${stopId}`);
            if (!rowsContainer || !statusEl) return;

            let tracking = busTracking.get(stopId);
            if (!tracking) {
                tracking = new Map();
                busTracking.set(stopId, tracking);
            }

            // Mevcut otobüsleri işaretle
            const currentLines = new Set(buses.map(b => b.line));

            // Yeni gelen otobüsleri güncelle
            for (const bus of buses) {
                tracking.set(bus.line, {
                    data: bus,
                    missCount: 0
                });
            }

            // Gelmeyen otobüslerin miss sayacını artır
            for (const [line, entry] of tracking) {
                if (!currentLines.has(line)) {
                    entry.missCount++;
                    if (entry.missCount >= (settings.missCount || 10)) {
                        tracking.delete(line);
                    }
                }
            }

            // Satırları oluştur
            const allBuses = Array.from(tracking.values())
                .sort((a, b) => {
                    // Dakikayı parse et ve sırala
                    const timeA = parseMinutes(a.data.time);
                    const timeB = parseMinutes(b.data.time);
                    return timeA - timeB;
                });

            if (allBuses.length === 0) {
                rowsContainer.innerHTML = `
                    <div class="bus-row empty-row">
                        <span class="empty-text">Sefer bulunamadı</span>
                    </div>
                `;
                statusEl.innerHTML = '';
                return;
            }

            statusEl.innerHTML = `<span class="pulse active"></span>`;

            // 10sn veri gelmezse kırmızı yap
            if (pulseTimers.has(stopId)) clearTimeout(pulseTimers.get(stopId));
            pulseTimers.set(stopId, setTimeout(() => {
                statusEl.innerHTML = `<span class="pulse error"></span>`;
            }, 10000));

            // Önceki değerleri kontrol et
            const prevValues = new Map();
            rowsContainer.querySelectorAll('.bus-row').forEach(row => {
                const lineEl = row.querySelector('.bus-line');
                const timeEl = row.querySelector('.bus-time');
                if (lineEl && timeEl) {
                    prevValues.set(lineEl.textContent.trim(), timeEl.textContent.trim());
                }
            });

            rowsContainer.innerHTML = allBuses.map(entry => {
                const bus = entry.data;
                const fading = entry.missCount > 0;
                const prevTime = prevValues.get(bus.line);
                const changed = prevTime && prevTime !== bus.time;
                return `
                    <div class="bus-row ${fading ? 'fading' : ''}">
                        <div class="bus-info">
                            <div class="bus-line">${bus.line}</div>
                            <div class="bus-name">${bus.lineName || ''}</div>
                        </div>
                        <div class="bus-time ${changed ? 'changed' : ''}" data-line="${bus.line}">${bus.time}</div>
                    </div>
                `;
            }).join('');

            // 1 saniye sonra yeşil efekti kaldır
            if (rowsContainer.querySelector('.bus-time.changed')) {
                setTimeout(() => {
                    rowsContainer.querySelectorAll('.bus-time.changed').forEach(el => {
                        el.classList.remove('changed');
                    });
                }, 1000);
            }
        }

        // Durak status göstergesi
        function updateStopStatus(stopId, status) {
            const statusEl = document.getElementById(`status-${stopId}`);
            if (!statusEl) return;
            if (status === 'active') {
                statusEl.innerHTML = `<span class="pulse active"></span>`;
            } else {
                statusEl.innerHTML = `<span class="pulse error"></span>`;
            }
        }

        // Dakikayı parse et (sıralama için)
        function parseMinutes(timeStr) {
            const match = timeStr.match(/(\d+)\s*dk/);
            if (match) return parseInt(match[1]);
            return 999;
        }

        // WebSocket
        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:3001');

                ws.onopen = () => {
                    wsStatusDot.className = 'status-dot active';
                    wsStatusText.textContent = 'Bağlı';
                    if (wsReconnectTimer) {
                        clearTimeout(wsReconnectTimer);
                        wsReconnectTimer = null;
                    }
                };

                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'stop-data') {
                            updateStopData(msg.stopId, msg.buses);
                        }
                    } catch (err) { }
                };

                ws.onclose = () => {
                    wsStatusDot.className = 'status-dot';
                    wsStatusText.textContent = 'Bağlantı kesildi';
                    wsReconnectTimer = setTimeout(connectWebSocket, 3000);
                };

                ws.onerror = () => {
                    wsStatusDot.className = 'status-dot';
                    wsStatusText.textContent = 'Hata';
                };
            } catch (err) {
                wsReconnectTimer = setTimeout(connectWebSocket, 3000);
            }
        }

        // Modal fonksiyonları
        function openModal() {
            editModal.classList.add('active');
            renderStopList();
            showCursor();
        }

        function closeModal() {
            editModal.classList.remove('active');
        }

        function renderStopList() {
            const stopList = document.getElementById('stop-list');
            stopList.innerHTML = stops.map((stop, index) => `
                <div class="bus-item">
                    <span class="bus-item-info">
                        <strong>Durak ${stop}</strong>
                    </span>
                    <button class="btn btn-delete" onclick="deleteStop(${index})">Sil</button>
                </div>
            `).join('');
        }

        function addStop() {
            const stop = document.getElementById('new-stop').value.trim();
            if (!stop) {
                alert('Durak numarası giriniz!');
                return;
            }
            if (stops.includes(stop)) {
                alert('Bu durak zaten ekli!');
                return;
            }
            stops.push(stop);
            document.getElementById('new-stop').value = '';
            renderStopList();
        }

        function deleteStop(index) {
            if (stops.length <= 1) {
                alert('En az bir durak olmalı!');
                return;
            }
            stops.splice(index, 1);
            renderStopList();
        }

        function saveAndReload() {
            localStorage.setItem('stops', JSON.stringify(stops));
            fetch('/api/update-stops', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(stops)
            }).then(() => {
                closeModal();
                busTracking.clear();
                initializeColumns();
            }).catch(err => {
                alert('Kaydetme hatası: ' + err.message);
            });
        }

        // DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeColumns();
            connectWebSocket();
        });

        // Info Modal
        const infoModal = document.getElementById('info-modal');

        async function openInfoModal() {
            infoModal.classList.add('active');
            showCursor();
            await loadAppInfo();
        }

        function closeInfoModal() {
            infoModal.classList.remove('active');
        }

        async function loadAppInfo() {
            try {
                const response = await fetch('/api/app-info');
                const data = await response.json();
                document.getElementById('app-version').textContent = 'v' + data.version;
                document.getElementById('app-name').textContent = data.name || 'EGO Otobüs Takip';

                const status = data.updateStatus;
                const statusEl = document.getElementById('update-status');
                const versionRow = document.getElementById('update-version-row');
                const installBtn = document.getElementById('install-update-btn');
                const progressRow = document.getElementById('download-progress-row');
                const progressBar = document.getElementById('download-progress-bar');
                const progressText = document.getElementById('download-progress-text');
                progressRow.style.display = 'none';

                if (status.checking) {
                    statusEl.textContent = 'Kontrol ediliyor...';
                    statusEl.className = 'info-value status-checking';
                } else if (status.downloading) {
                    statusEl.textContent = 'İndiriliyor...';
                    statusEl.className = 'info-value status-downloading';
                    versionRow.style.display = 'flex';
                    document.getElementById('update-version').textContent = 'v' + status.version;
                    progressRow.style.display = 'flex';
                    progressBar.style.width = status.downloadProgress + '%';
                    progressText.textContent = status.downloadProgress + '%';
                } else if (status.downloaded) {
                    statusEl.textContent = 'İndirildi, yeniden başlatmayı bekliyor';
                    statusEl.className = 'info-value status-ready';
                    installBtn.style.display = 'inline-block';
                } else if (status.available) {
                    statusEl.textContent = 'Güncelleme mevcut';
                    statusEl.className = 'info-value status-available';
                    versionRow.style.display = 'flex';
                    document.getElementById('update-version').textContent = 'v' + status.version;
                } else {
                    statusEl.textContent = 'Güncel ✓';
                    statusEl.className = 'info-value status-ok';
                }

                if (status.lastCheck) {
                    document.getElementById('last-check').textContent = new Date(status.lastCheck).toLocaleTimeString('tr-TR');
                }
            } catch (error) { }
        }

        async function checkForUpdates() {
            document.getElementById('update-status').textContent = 'Kontrol ediliyor...';
            try {
                await fetch('/api/check-update', { method: 'POST' });
                setTimeout(loadAppInfo, 2000);
            } catch (error) { }
        }

        async function installUpdate() {
            if (confirm('Uygulama kapatılıp güncelleme yüklenecek. Devam edilsin mi?')) {
                await fetch('/api/install-update', { method: 'POST' });
            }
        }

        // Settings Modal
        const settingsModal = document.getElementById('settings-modal');

        function openSettingsModal() {
            settingsModal.classList.add('active');
            showCursor();
            document.getElementById('setting-miss-count').value = settings.missCount || 10;
            document.getElementById('setting-scrape-delay').value = settings.scrapeDelay || 500;
            document.getElementById('setting-cursor-timeout').value = settings.cursorTimeout || 5;
        }

        function closeSettingsModal() {
            settingsModal.classList.remove('active');
        }

        function saveSettings() {
            settings.missCount = parseInt(document.getElementById('setting-miss-count').value) || 10;
            settings.scrapeDelay = parseInt(document.getElementById('setting-scrape-delay').value) || 500;
            settings.cursorTimeout = parseInt(document.getElementById('setting-cursor-timeout').value) || 5;
            localStorage.setItem('settings', JSON.stringify(settings));
            closeSettingsModal();
        }

        // Klavye kısayolları
        document.addEventListener('keydown', (e) => {
            const anyModalOpen = editModal.classList.contains('active') || infoModal.classList.contains('active') || settingsModal.classList.contains('active');

            if (e.key === 'f' || e.key === 'F') {
                if (!anyModalOpen) {
                    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                    else document.exitFullscreen();
                }
            }

            if (e.key === 'e' || e.key === 'E') {
                if (!anyModalOpen || editModal.classList.contains('active')) {
                    editModal.classList.contains('active') ? closeModal() : openModal();
                }
            }

            if (e.key === 'q' || e.key === 'Q') {
                if (!anyModalOpen || infoModal.classList.contains('active')) {
                    infoModal.classList.contains('active') ? closeInfoModal() : openInfoModal();
                }
            }

            if (e.key === 's' || e.key === 'S') {
                if (!anyModalOpen || settingsModal.classList.contains('active')) {
                    settingsModal.classList.contains('active') ? closeSettingsModal() : openSettingsModal();
                }
            }

            if (e.key === 'Escape') {
                closeModal();
                closeInfoModal();
                closeSettingsModal();
            }
        });
    </script>
</body>

</html>