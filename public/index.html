<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGO Otobüs Takip</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <img src="icon.png" class="logo" alt="Logo">
                <h1>Otobüsler</h1>
            </div>
            <div class="header-right">
                <div class="clock" id="clock">--:--:--</div>
                <div class="update-info">
                    <span class="update-label">Son Güncelleme:</span>
                    <span class="update-time" id="last-update">--:--:--</span>
                </div>
            </div>
        </header>

        <!-- Bus Cards Container -->
        <main class="cards-container" id="app-container">
        </main>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-item" id="connection-status">
                <span class="status-dot" id="ws-dot"></span>
                <span id="ws-status">Bağlanıyor...</span>
            </div>
            <div class="status-item" id="perf-display">
                <span>⏱️ Gerçek zamanlı</span>
            </div>
        </footer>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Otobüs Düzenle</h2>
                <button class="modal-close" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="bus-list" id="bus-list">
                </div>
                <div class="add-bus-form">
                    <h3>Yeni Otobüs Ekle</h3>
                    <div class="form-row">
                        <input type="text" id="new-line" placeholder="Hat No (örn: 561)">
                        <input type="text" id="new-stop" placeholder="Durak No (örn: 50782)">
                        <button class="btn btn-add" onclick="addBus()">+ Ekle</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-save" onclick="saveAndReload()">Kaydet ve Yenile</button>
            </div>
        </div>
    </div>

    <!-- Info Modal (Q tuşu) -->
    <div class="modal-overlay" id="info-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Uygulama Bilgileri</h2>
                <button class="modal-close" onclick="closeInfoModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Sürüm</span>
                        <span class="info-value" id="app-version">Yükleniyor...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Uygulama</span>
                        <span class="info-value" id="app-name">EGO Otobüs Takip</span>
                    </div>
                </div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Güncelleme Durumu</span>
                        <span class="info-value" id="update-status">Kontrol ediliyor...</span>
                    </div>
                    <div class="info-row" id="update-version-row" style="display: none;">
                        <span class="info-label">Yeni Sürüm</span>
                        <span class="info-value" id="update-version">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Son Kontrol</span>
                        <span class="info-value" id="last-check">-</span>
                    </div>
                </div>
                <div class="info-actions">
                    <button class="btn btn-primary" onclick="checkForUpdates()">Güncelleme Kontrol Et</button>
                    <button class="btn btn-save" id="install-update-btn" style="display: none;"
                        onclick="installUpdate()">Güncellemeyi Yükle</button>
                </div>
            </div>
            <div class="modal-footer">
                <span class="info-hint">E: Otobüs Düzenle | F: Tam Ekran</span>
            </div>
        </div>
    </div>

    <script>
        // LocalStorage'dan otobüsleri yükle veya varsayılan kullan
        let buses = JSON.parse(localStorage.getItem('buses')) || [
            { id: 'bus-1', line: '561', stop: '50782' },
            { id: 'bus-2', line: '561', stop: '50781' },
            { id: 'bus-3', line: '561', stop: '50780' }
        ];

        const container = document.getElementById('app-container');
        const lastUpdateElement = document.getElementById('last-update');
        const clockElement = document.getElementById('clock');
        const editModal = document.getElementById('edit-modal');
        const wsStatusDot = document.getElementById('ws-dot');
        const wsStatusText = document.getElementById('ws-status');

        let ws = null;
        let wsReconnectTimer = null;

        // Mouse gizleme - 5 saniye hareketsizlik
        let mouseTimer;
        let cursorHidden = false;

        function showCursor() {
            document.body.style.cursor = 'default';
            cursorHidden = false;
            clearTimeout(mouseTimer);
            mouseTimer = setTimeout(hideCursor, 5000);
        }

        function hideCursor() {
            document.body.style.cursor = 'none';
            cursorHidden = true;
        }

        document.addEventListener('mousemove', showCursor);
        document.addEventListener('mousedown', showCursor);
        mouseTimer = setTimeout(hideCursor, 5000);

        // Saat güncellemesi
        function updateClock() {
            const now = new Date();
            clockElement.textContent = now.toLocaleTimeString('tr-TR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        function updateLastUpdateTime() {
            const now = new Date();
            lastUpdateElement.textContent = now.toLocaleTimeString('tr-TR');
        }

        function initializeCards() {
            container.innerHTML = '';
            buses.forEach(bus => {
                const card = document.createElement('div');
                card.className = 'bus-card loading';
                card.id = bus.id;
                card.innerHTML = `
                    <div class="card-header">
                        <div class="line-badge">${bus.line}</div>
                        <div class="status-indicator loading">
                            <span class="pulse"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="arrival-time loading">--:--</div>
                        <div class="arrival-label">Tahmini Varış</div>
                    </div>
                    <div class="card-footer">
                        <span class="stop-info">Durak: ${bus.stop}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // WebSocket bağlantısı
        function connectWebSocket() {
            const wsUrl = `ws://localhost:3001`;

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('[WS] Bağlandı');
                    wsStatusDot.className = 'status-dot active';
                    wsStatusText.textContent = 'Bağlı';

                    if (wsReconnectTimer) {
                        clearTimeout(wsReconnectTimer);
                        wsReconnectTimer = null;
                    }
                };

                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);

                        if (msg.type === 'bus-data') {
                            updateBusCard(msg.busId, msg.data);
                            updateLastUpdateTime();
                        } else if (msg.type === 'bus-status') {
                            updateBusStatus(msg.busId, msg.status, msg.message);
                        }
                    } catch (err) {
                        console.error('[WS] Parse error:', err);
                    }
                };

                ws.onclose = () => {
                    console.log('[WS] Bağlantı kapandı');
                    wsStatusDot.className = 'status-dot';
                    wsStatusText.textContent = 'Bağlantı kesildi';

                    // 3 saniye sonra yeniden bağlan
                    wsReconnectTimer = setTimeout(connectWebSocket, 3000);
                };

                ws.onerror = (err) => {
                    console.error('[WS] Hata:', err);
                    wsStatusDot.className = 'status-dot';
                    wsStatusText.textContent = 'Hata';
                };

            } catch (err) {
                console.error('[WS] Bağlantı hatası:', err);
                wsReconnectTimer = setTimeout(connectWebSocket, 3000);
            }
        }

        function updateBusCard(busId, data) {
            const card = document.getElementById(busId);
            if (!card) return;

            const arrivalTime = card.querySelector('.arrival-time');
            const statusIndicator = card.querySelector('.status-indicator');

            card.classList.remove('loading', 'active', 'inactive');
            arrivalTime.classList.remove('loading');

            if (data.found) {
                card.classList.add('active');
                arrivalTime.textContent = data.time;
                statusIndicator.innerHTML = '<span class="pulse active"></span>';
                statusIndicator.className = 'status-indicator active';
            } else {
                card.classList.add('inactive');
                arrivalTime.textContent = data.time || 'Sefer Yok';
                statusIndicator.innerHTML = '';
                statusIndicator.className = 'status-indicator inactive';
            }
        }

        function updateBusStatus(busId, status, message) {
            const card = document.getElementById(busId);
            if (!card) return;

            const statusIndicator = card.querySelector('.status-indicator');

            if (status === 'loading' || status === 'clicking' || status === 'starting') {
                card.classList.remove('active', 'inactive');
                card.classList.add('loading');
                statusIndicator.innerHTML = '<span class="pulse"></span>';
                statusIndicator.className = 'status-indicator loading';
            } else if (status === 'error' || status === 'waiting') {
                statusIndicator.innerHTML = '';
                statusIndicator.className = 'status-indicator inactive';
            }
        }

        // Modal fonksiyonları
        function openModal() {
            editModal.classList.add('active');
            renderBusList();
            showCursor();
        }

        function closeModal() {
            editModal.classList.remove('active');
        }

        function renderBusList() {
            const busList = document.getElementById('bus-list');
            busList.innerHTML = buses.map((bus, index) => `
                <div class="bus-item">
                    <span class="bus-item-info">
                        <strong>Hat ${bus.line}</strong> - Durak: ${bus.stop}
                    </span>
                    <button class="btn btn-delete" onclick="deleteBus(${index})">Sil</button>
                </div>
            `).join('');
        }

        function addBus() {
            const line = document.getElementById('new-line').value.trim();
            const stop = document.getElementById('new-stop').value.trim();

            if (!line || !stop) {
                alert('Hat ve durak numarası giriniz!');
                return;
            }

            const newId = 'bus-' + Date.now();
            buses.push({ id: newId, line, stop });

            document.getElementById('new-line').value = '';
            document.getElementById('new-stop').value = '';

            renderBusList();
        }

        function deleteBus(index) {
            if (buses.length <= 1) {
                alert('En az bir otobüs olmalı!');
                return;
            }
            buses.splice(index, 1);
            renderBusList();
        }

        function saveAndReload() {
            buses = buses.map((bus, index) => ({
                ...bus,
                id: 'bus-' + (index + 1)
            }));

            localStorage.setItem('buses', JSON.stringify(buses));

            fetch('/api/update-buses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(buses)
            }).then(() => {
                closeModal();
                initializeCards();
            }).catch(err => {
                alert('Kaydetme hatası: ' + err.message);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeCards();
            connectWebSocket();
        });

        // Info Modal fonksiyonları
        const infoModal = document.getElementById('info-modal');

        async function openInfoModal() {
            infoModal.classList.add('active');
            showCursor();
            await loadAppInfo();
        }

        function closeInfoModal() {
            infoModal.classList.remove('active');
        }

        async function loadAppInfo() {
            try {
                const response = await fetch('/api/app-info');
                const data = await response.json();

                document.getElementById('app-version').textContent = 'v' + data.version;
                document.getElementById('app-name').textContent = data.name || 'EGO Otobüs Takip';

                const status = data.updateStatus;
                const statusEl = document.getElementById('update-status');
                const versionRow = document.getElementById('update-version-row');
                const installBtn = document.getElementById('install-update-btn');

                if (status.checking) {
                    statusEl.textContent = 'Kontrol ediliyor...';
                    statusEl.className = 'info-value status-checking';
                } else if (status.downloaded) {
                    statusEl.textContent = 'İndirildi, yeniden başlatmayı bekliyor';
                    statusEl.className = 'info-value status-ready';
                    installBtn.style.display = 'inline-block';
                } else if (status.available) {
                    statusEl.textContent = 'Güncelleme mevcut';
                    statusEl.className = 'info-value status-available';
                    versionRow.style.display = 'flex';
                    document.getElementById('update-version').textContent = 'v' + status.version;
                } else {
                    statusEl.textContent = 'Güncel ✓';
                    statusEl.className = 'info-value status-ok';
                }

                if (status.lastCheck) {
                    const date = new Date(status.lastCheck);
                    document.getElementById('last-check').textContent = date.toLocaleTimeString('tr-TR');
                }

            } catch (error) {
                console.error('App info yüklenemedi:', error);
            }
        }

        async function checkForUpdates() {
            document.getElementById('update-status').textContent = 'Kontrol ediliyor...';
            try {
                await fetch('/api/check-update', { method: 'POST' });
                setTimeout(loadAppInfo, 2000);
            } catch (error) {
                console.error('Güncelleme kontrolü başarısız:', error);
            }
        }

        async function installUpdate() {
            if (confirm('Uygulama kapatılıp güncelleme yüklenecek. Devam edilsin mi?')) {
                await fetch('/api/install-update', { method: 'POST' });
            }
        }

        // Klavye kısayolları
        document.addEventListener('keydown', (e) => {
            const anyModalOpen = editModal.classList.contains('active') || infoModal.classList.contains('active');

            // F tuşu - tam ekran
            if (e.key === 'f' || e.key === 'F') {
                if (!anyModalOpen) {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                }
            }

            // E tuşu - düzenleme paneli
            if (e.key === 'e' || e.key === 'E') {
                if (!infoModal.classList.contains('active')) {
                    if (editModal.classList.contains('active')) {
                        closeModal();
                    } else {
                        openModal();
                    }
                }
            }

            // Q tuşu - özellikler paneli
            if (e.key === 'q' || e.key === 'Q') {
                if (!editModal.classList.contains('active')) {
                    if (infoModal.classList.contains('active')) {
                        closeInfoModal();
                    } else {
                        openInfoModal();
                    }
                }
            }

            // ESC tuşu - modalları kapat
            if (e.key === 'Escape') {
                closeModal();
                closeInfoModal();
            }
        });
    </script>
</body>

</html>